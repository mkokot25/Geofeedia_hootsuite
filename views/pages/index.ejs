<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
   <head>
      <title>Geofeedia</title>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

      <script type="text/javascript" src="http://ecn.dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=7.0"></script>
	    <link href="/post.css" rel="stylesheet" type="text/css">
	     <link href="/bootstrap.css" rel="stylesheet" type="text/css">
      <script>
         
         var map = null;
         
 
         function GetMap()
         {
            // Initialize the map
            map = new Microsoft.Maps.Map(document.getElementById("mapDiv"),{credentials:"Ansr7k7sdmmW_DFB1q-vDmNbwNcqaHcW3cFr9eQLaWI1A85k27rtCJQaIBJo9JPx", mapTypeId:Microsoft.Maps.MapTypeId.road}); 

         }

         function ClickGeocode(credentials)
         {
            map.getCredentials(MakeGeocodeRequest);
         }

         function MakeGeocodeRequest(credentials)
         {

            var geocodeRequest = "http://dev.virtualearth.net/REST/v1/Locations?query=" + encodeURI(document.getElementById('txtQuery').value) + "&output=json&jsonp=GeocodeCallback&key=" + credentials;
			alert(geocodeRequest);
            CallRestService(geocodeRequest);
         }

         function GeocodeCallback(result) 
         {
            //alert("Found location: " + result.resourceSets[0].resources[0].name);
			var lat = result.resourceSets[0].resources[0].point.coordinates[0]
			var lon = result.resourceSets[0].resources[0].point.coordinates[1]
			
			
			
            if (result &&
                   result.resourceSets &&
                   result.resourceSets.length > 0 &&
                   result.resourceSets[0].resources &&
                   result.resourceSets[0].resources.length > 0) 
            {
               // Set the map view using the returned bounding box
               var bbox = result.resourceSets[0].resources[0].bbox;
               var viewBoundaries = Microsoft.Maps.LocationRect.fromLocations(new Microsoft.Maps.Location(bbox[0], bbox[1]), new Microsoft.Maps.Location(bbox[2], bbox[3]));
               map.setView({ bounds: viewBoundaries});

				// Add a pushpin at the found location
               var location = new Microsoft.Maps.Location(result.resourceSets[0].resources[0].point.coordinates[0], result.resourceSets[0].resources[0].point.coordinates[1]);
               var pushpin = new Microsoft.Maps.Pushpin(location);
               map.entities.push(pushpin);

   
            
            var url = "https://api.geofeedia.com/v1/search/latlon/"+lat+","+lon+",5.0?appId=3c7f0f3c&appKey=d71ba6aa64fd467bb69f7d39125012e1";
    
    		var response = httpGet(url);
    		obj = JSON.parse(response);
    		alert(response);
    		$("#geo").remove();
    		 
   		 	$("#geofeedia").append("<table id='geo'></table>");
    		
    		//refresh(document.getElementById('txtQuery').value, url);
    		
    		for (i = 0; i < obj.items.length; i++) 
    		{ 
    		
    	
    		var source = obj.items[i].source;
    		var date = obj.items[i].publishDate;
    		var title = obj.items[i].title;
    		var description = obj.items[i].description;
    		var name = obj.items[i].author.name;
    		var name_link = obj.items[i].author.url;
    		var post_link = obj.items[i].url;
    		var media_type = obj.items[i].mediaItems[0].type;
    		var image = obj.items[i].mediaItems[0].media[0].thumbnail.url;
    		var lat = obj.items[i].latitude;
    		var lon = obj.items[i].longitude;
    		
    		
    		var logo = "";
    		if(source == "instagram"){
    		logo = "http://www.iconarchive.com/download/i80462/uiconstock/socialmedia/Instagram.ico";
    		}else if(source == "facebook"){
    		logo = "http://inwallspeakers1.com/wp-content/uploads/2015/06/facebook-logo-png-transparent-background.png";
    		}else if(source == "twitter"){
    		logo = "http://www.adweek.com/socialtimes/files/2014/07/alltwitter-twitter-bird-logo-white-on-blue.png";
    		}else if(source == "flickr"){
    		logo = "http://www.timothypflaniganmd.com/wp-content/uploads/2014/12/flickr-logo-transparent.png";
    		}
    		
    		
    	

    		$("#geo").append("<div class='container' id='container"+ i +"'></div>");
    		button = "<a href='"+post_link+"' target='_blank'><button type='button' class='btn btn-primary toProfile' style='width:400px;margin-bottom:10px;'>Comment</button></a>";
    		
    		main_image1 = "<div class='box'><div class='firstcell'><img class='main_image' src='"+image+"' alt=''/></div><div class='content'><div class='box2'><p>" + title + "</p></div></div></div>";
    		logo3 = "<div class='content'><div class='box3'><img class='logo' src='" + logo + "'/><div class='userstamp'><a href='"+name_link+"'>"+ name + "</a><br/>"+ date +"</div></div></div>";
    		
    		$("#container"+i).append(main_image1).append(logo3).after(button);
    		}
            }else{
            alert("The has been an error");
            
            }
            
         }
        
         
         
         function refresh(text, url)
         {
         
         setTimeout(function(){ 
         if(text==document.getElementById('txtQuery').value){
         
    	 var response = httpGet(url);
    	 obj = JSON.parse(response);
         
            var source = obj.items[i].source;
    		var date = obj.items[i].publishDate;
    		var title = obj.items[i].title;
    		var description = obj.items[i].description;
    		var name = obj.items[i].author.name;
    		var name_link = obj.items[i].author.url;
    		var post_link = obj.items[i].url;
    		var media_type = obj.items[i].mediaItems[0].type;
    		var image = obj.items[i].mediaItems[0].media[0].thumbnail.url;
    		var lat = obj.items[i].latitude;
    		var lon = obj.items[i].longitude;
    		alert(date);
         
        //alert($("#geo").children("tr:first").text());
         
         
         }
         }, 5000);
         }

         function CallRestService(request) 
         {
            var script = document.createElement("script");
            script.setAttribute("type", "text/javascript");
            script.setAttribute("src", request);
            document.body.appendChild(script);
         }

		function httpGet(theUrl)
		{
   		 var xmlHttp = new XMLHttpRequest();
    	xmlHttp.open( "GET", theUrl, false );
    	xmlHttp.send( null );
    
    	return xmlHttp.responseText;
		}


      </script>
   </head>
   
   <body id='entire' onload="GetMap();">
	<script src="/jquery-2.1.4.js"></script>


      <div id='mapDiv' style="position:relative; width:100%; height:400px;"></div>
      		<input id="txtQuery" type="text" value="Portland" />
      		<input type="button"  type='button' class='btn btn-primary toProfile' value="Geocode" onclick="ClickGeocode()"/>    
      

      
      <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true"></script>
    <div id="geofeedia"><div id='geo'></div></div>
    
	<script>
hsp.init({apiKey:"e2weulwolrsw0ocwc404k4o8k3icmckml5k"});
</script>
	
	
<script src="https://d2l6uygi1pgnys.cloudfront.net/jsapi/2-0/hsp.js">
</script> 
   


   </body>
</html>